name: Parse 10F Menu

on:
  push:
    paths:
      - 'images/**'
  workflow_dispatch:

jobs:
  parse-menu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # rebase 위해 전체 히스토리

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @google/generative-ai

      - name: Setup Gemini API Key
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV

      - name: Find images
        id: find-images
        run: |
          IMAGES=$(find images -maxdepth 1 -type f \( -iname "*.png" \) || true)

          if [ -z "$IMAGES" ]; then
            echo "No images found"
            echo "has_images=false" >> $GITHUB_OUTPUT
          else
            echo "Found images:"
            echo "$IMAGES"
            echo "has_images=true" >> $GITHUB_OUTPUT
          fi

      - name: Parse all images
        if: steps.find-images.outputs.has_images == 'true'
        run: |
          set -e

          mkdir -p data-10f

          for img in images/*.png images/*.PNG; do
            [ -e "$img" ] || continue

            echo "Parsing $img"

            if node parse-10f-menu.js "$img"; then
              echo "Parsed successfully: $img"
              rm "$img"
            else
              echo "Failed to parse: $img"
            fi
          done

      - name: Commit and push results safely
        if: steps.find-images.outputs.has_images == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add data-10f images

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Parse 10F menu images"

          # 최신 main 위로 재배치 (동시 실행 대비)
          git pull --rebase origin main

          git push origin main
